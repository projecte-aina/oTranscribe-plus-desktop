<!DOCTYPE html>
<html manifest="manifest.appcache">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>oTranscribe</title>

        <meta name="description" content="A free HTML5 app to take the pain out of transcribing interviews. Useful for journalists, academics and anyone else transcribing audio. And it's open source, too.">
    <!-- <link rel="icon" type="image/png" href="favicon.png" /> -->

    <!-- Twitter meta tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="http://otranscribe.com">
    <meta name="twitter:title" content="oTranscribe">
    <meta name="twitter:description" content="A free HTML5 app to take the pain out of transcribing interviews. Useful for journalists, academics and anyone else transcribing audio. And it's open source, too.">
    <meta name="twitter:site" content="@oTranscribe">
    <meta name="twitter:image" content="http://otranscribe.com/favicon.png">

    <!-- Facebook meta tags -->
    <meta property="og:title" content="oTranscribe">
    <meta property="og:image" content="http://otranscribe.com/favicon.png">
    <meta property="og:description" content="A free HTML5 app to take the pain out of transcribing interviews. Useful for journalists, academics and anyone else transcribing audio. And it's open source, too.">


	<link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <link rel="prefetch" type="application/l10n" href="data.ini" />
<script defer src="bundle.js"></script><link href="style.css" rel="stylesheet"></head>

<body>
    <script type="application/javascript" src="vosk.js"></script>
    <script type="text/javascript" src="l10n.js"></script>
    <script src="./jakecache.js" type="text/javascript" charset="utf-8"></script>

    <div class="topbar inputting">
    <div class="title active">oTranscribe</div>
    <div class="controls">
        <div class="button play-pause">
            <i class="fa fa-play"></i><i class="fa fa-pause"></i>
            <div class="topbar-button-shortcut" data-shortcut="playPause"></div>
        </div>
        <div class="button skip-backwards">
            <i class="fa fa-backward"></i>
            <div class="topbar-button-shortcut" data-shortcut="backwards"></div>
        </div>
        <div class="button skip-forwards">
            <i class="fa fa-forward"></i>
            <div class="topbar-button-shortcut" data-shortcut="forwards"></div>
        </div>
        <div class="button speed"><i class="fa fa-dashboard"></i> <span data-l10n-id="speed">speed</span>
        		<div class="speed-box">
                    <span data-shortcut="speedDown"></span>
                    <i class="slider-origin"></i>
                    <input class="speed-slider" type ="range" min ="0.5" max="2.0" step ="0.25" value ="1"/>
                    <span data-shortcut="speedUp"></span>
        		</div>
            </div>
        <div id="player-hook"></div>
        <div class="button player-time"></div>
        <div class="time-selection">
            <label>
                <span data-l10n-id="jump-to-time">Jump to time:</span>
                <input type="text" value="0:00" class="mousetrap" />
            </label>
        </div>
        <div class="button reset"><i class="fa fa-refresh"></i></div>
    </div>
    <a href="help" target="_blank" data-l10n-id="help" class="help-title">Help</a>
    <div class="language-title">
        <i class="fa fa-globe"></i> <span id="curr-lang"></span>
    </div>
    <div class="settings-button">
        <i class="fa fa-cog" aria-hidden="true"></i>
    </div>
</div>
            
            
<div class="language-picker">
    <div class="container">
         language buttons injected here 
    </div>
</div>            

    <div class="about active">
    <div class="container">
    <h1>oTranscribe</h1>

    <p class="lead" data-l10n-id="lead">A free web app to take the pain out of transcribing recorded interviews.</p>

    <div class="start">
        <span class="start-loading" data-l10n-id="start-loading">Loading...</span>
        <span class="start-ready" data-l10n-id="start-ready">Start transcribing</span>
    </div>
    <div id="old-browser"></div>
    <div class="mobile" data-l10n-id="mobile-warning">oTranscribe works on desktop computers only.</div>


    <ul>
        <li data-l10n-id="promo-1"><strong>No more switching</strong> between Quicktime and Word.</li><!--
        --><li data-l10n-id="promo-2"><strong>Pause, rewind and fast-forward</strong> without taking your hands off the keyboard.</li><!--
        --><li data-l10n-id="promo-3">Navigate through your transcript with <strong>interactive timestamps</strong>.</li><!--
        --><li data-l10n-id="promo-4"><strong>Automatically saved</strong> to your browser's storage every second.</li><!--
        --><li data-l10n-id="promo-5"><strong>Private</strong> - your audio file and transcript <em>never</em> leave your computer.</li><!--
        --><li data-l10n-id="promo-6"><strong>Export</strong> to Markdown, plain text and Google Docs.</li><!--
        --><li data-l10n-id="promo-7"><strong>Video file support</strong> with integrated player.</li><!--
        --><li data-l10n-id="promo-8"><strong><a href="opensource">Open source</a></strong> under the MIT license.</li>
    </ul>
    
    <div class="press">
    <p data-l10n-id="press">As featured on</p>
    <a href="http://thenextweb.com/apps/2014/01/08/otranscribe-simple-useful-free-web-app-transcription">
        <img src="img/tnw_logo.png">
    </a><!--
    --><a href="http://www.theguardian.com/media/2014/jan/22/ten-tools-for-digital-and-citizen-journalists-on-the-go">
        <img src="img/gdn_logo.png">
    </a><!--
    --><a href="http://lifehacker.com/otranscribe-is-a-free-keyboard-friendly-transcription-1498812713">
        <img src="img/lh_logo.png">
    </a><!--
    --><a href="http://www.fastcolabs.com/3024571/is-this-the-transcription-app-journalists-have-been-waiting-for">
        <img src="img/fastco_logo.png">
    </a><!--
    --><a href="http://www.journalism.co.uk/news/journalist-creates-web-app-for-audio-transcription/s2/a555258/">
        <img src="img/jcu_logo.png">
    </a><!--
    --><a href="http://wannabehacks.co.uk/2013/12/19/otranscribe-a-new-tool-to-help-make-transcribing-audio-easier/">
        <img src="img/wh_logo.png">
    </a>
    </div>
    
    </div>
    
    


    <div class="credits">
        <p>
            <a class="twitter" href="https://twitter.com/oTranscribe" data-l10n-id="twitter"><i class="fa fa-twitter"></i> Follow @oTranscribe</a>
            <span>
                <span data-l10n-id="credit">Created by</span>
                <a href="http://twitter.com/elliot_bentley">Elliot Bentley</a>.
                A project of the <a href="https://www.muckrock.com/about/">MuckRock Foundation</a>.
            </span>
        </p>
        <p>
            <a href="privacy" target="_blank" data-l10n-id="privacy">Privacy policy</a>
        </p>
    </div>

</div>


    <div class="textbox-container">
    <div class="input active">
        <div class="file-input-outer"></div>    
        <div id="lastfile"></div>
        <div id="formats"></div>
    </div>
    
    <div class="message-panel hidden">
            <div class="close-message-panel"><i class="fa fa-times"></i></div>
            <div class="message-content"></div>
    </div>


    <script>
        let model = null;
        let recognizer = null;
        let source = null;
        var currentFile = null;
        let lastTimestampedMin = 0;

        function stop() {
            console.log("stopping");
            lastTimestampedMin = 0;
            if (model !== null) {
                model.terminate();
                model = null;
            }
            if (recognizer !== null) {
                recognizer.remove();
                recognizer = null;
            }
            if (source !== null) {
                source.disconnect();
                source = null;
            }
        }

        function autoTimestamp(second) {
            let currentMinute = Math.floor(second / 60);
            if ((currentMinute === 0) || (currentMinute === lastTimestampedMin)) {
                return null;
            }
            lastTimestampedMin = currentMinute;
            let time = {
                formatted: window.formatMilliseconds(second),
                raw: second
            };
            return window.createTimestampEl(time);
        }

        function onPartialResult(message) {
            const partialContainer = document.getElementById('partial');
            const partial = message.result.partial;
            partialContainer.textContent = partial;
        }

        function onResult(message) {
            const partialContainer = document.getElementById('partial');
            const resultsContainer = document.getElementById('textbox');
            const grayValues = "0123456789ABCDEF";
            const space = document.createTextNode("\u00A0");
            let timestamp = null;
            
            const result = message.result;
            if (result.text === "") {
                return;
            }
            console.log("Result:", message);
            result.result.forEach( (e) => {
                var idx = (14 - Math.round(e.conf * 14)) + 2;
                var chr = grayValues[idx];
                const newSpan = document.createElement('span');
                newSpan.textContent = e.word + " ";
                newSpan.title = e.conf;
                newSpan.style.cssText = `color: #${chr}${chr}${chr};`
                newSpan.dataset.meta = JSON.stringify(e);

                timestamp = autoTimestamp(e["start"]);
                if (timestamp !== null) {
                    resultsContainer.insertAdjacentElement("beforeend", timestamp);
                    const spaceSpan = document.createElement('span');
                    spaceSpan.textContent = " ";                    
                    resultsContainer.insertAdjacentElement("beforeend", spaceSpan);
                }

                resultsContainer.insertAdjacentElement("beforeend", newSpan);
            });
            partialContainer.textContent = "";
        }

        async function readFromMicro() {  
            stop();

            const partialContainer = document.getElementById('partial');         
            const modelName = document.getElementById("model").value;
            console.log("Loading model: ", modelName);

            partialContainer.textContent = document.webL10n.get('loadingModel');
            
            const channel = new MessageChannel();
            model = await Vosk.createModel('models/' + modelName);
            model.registerPort(channel.port1);

            const sampleRate = 48000;
            
            recognizer = new model.KaldiRecognizer(sampleRate);
            recognizer.setWords(true);
            recognizer.on("result", onResult);
            recognizer.on("partialresult", onPartialResult);

            partialContainer.textContent = "Ready";
            
            const mediaStream = await navigator.mediaDevices.getUserMedia({
                video: false,
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    channelCount: 1,
                    sampleRate
                },
            });
            
            const audioContext = new AudioContext();
            await audioContext.audioWorklet.addModule('recognizer-processor.js')
            const recognizerProcessor = new AudioWorkletNode(audioContext, 'recognizer-processor', { channelCount: 1, numberOfInputs: 1, numberOfOutputs: 1 });
            recognizerProcessor.port.postMessage({action: 'init', recognizerId: recognizer.id}, [ channel.port2 ])
            recognizerProcessor.connect(audioContext.destination);
            
            source = audioContext.createMediaStreamSource(mediaStream);
            source.connect(recognizerProcessor);
        }

        async function readFromFile(e) {
            if (currentFile === null) {
                const fileNotFoundText = document.webL10n.get('fileNotFound');
                alert(fileNotFoundText);
                return;
            }

            stop();

            const file = currentFile; // e.target.files[0];
            const partialContainer = document.getElementById('partial');
            const audioRef = document.getElementById('audio-ref')
            const modelName = document.getElementById("model").value;
            console.log("Loading ", modelName);

            partialContainer.textContent = document.webL10n.get('loadingModel');
            
            const channel = new MessageChannel();
            model = await Vosk.createModel('models/' + modelName);
            model.registerPort(channel.port1);

            const sampleRate = 48000;
            recognizer = new model.KaldiRecognizer(sampleRate);
            recognizer.setWords(true);
            recognizer.on("result", onResult);
            recognizer.on("partialresult", onPartialResult);


            // const [audioSource, setAudioSource] = useState<MediaElementAudioSourceNode>();
            
            const fileUrl = URL.createObjectURL(file);
            const audioPlayer = audioRef; //.current;
            audioPlayer.src = fileUrl;

            const audio = new Audio(fileUrl);
            const ctx = new AudioContext();
            const stream_dest = ctx.createMediaStreamDestination();
            const source = ctx.createMediaElementSource(audioPlayer);
            
            await ctx.audioWorklet.addModule('recognizer-processor.js')
            const recognizerProcessor = new AudioWorkletNode(ctx, 'recognizer-processor', { channelCount: 1, numberOfInputs: 1, numberOfOutputs: 1 });
            recognizerProcessor.port.postMessage({action: 'init', recognizerId: recognizer.id}, [ channel.port2 ])
            recognizerProcessor.connect(ctx.destination);

            source.connect(recognizerProcessor);

        }
    </script>


    <div style="display: flex; justify-content:center; margin:auto; margin-bottom: 20px; width: 20%;">
        <div style="display: inline;">
        <select name="model" id="model" style="width: 100%;">
            <option value="vosk-model-small-fa-0.4.tar.gz">Farsi</option>
            <option value="vosk-model-small-es-0.3.tar.gz">Español</option>
            <option value="vosk-model-small-fr-pguyot-0.3.tar.gz">French</option>
            <option value="vosk-model-small-vn-0.3.tar.gz">Vietnamese</option>
            <option value="vosk-model-small-pt-0.3.tar.gz">Portuguese</option>
            <option value="vosk-model-small-en-us-0.15.tar.gz">English</option>
            <option value="vosk-model-small-de-0.15.tar.gz">Deutsch</option>
            <option value="vosk-model-small-it-0.4.tar.gz">Italiano</option>
            <option value="vosk-model-small-cn-0.3.tar.gz">Chinese</option>
            <option value="vosk-model-small-tr-0.3.tar.gz">Turkish</option>
            <option value="vosk-model-small-ru-0.4.tar.gz">Russian</option>
            <option value="vosk-model-small-ca-0.4.tar.gz" selected="true">Catalan</option>
            <option value="vosk-model-small-en-in-0.4.tar.gz">Indian English</option>
          </select>
        </div>
    </div>

    <div style="display: block;margin: auto;width: 30%;">
        <div style="display: flex;flex-direction: row;justify-content: space-around;">
            <p style="text-align: center; margin: 0 2rem;">
                <button id="buttonReadFromMicro" class="alt-input-button" onclick="readFromMicro()">Write from micro</button>
            </p>
            <p style="text-align: center; margin: 0 2rem;">
                <audio id="audio-ref" autoplay></audio>
                <button id="buttonReadFromFile" class="alt-input-button" onclick="readFromFile()">Write from micro</button>
            </p>
            <script>
                window.addEventListener('localized', function(event) {
                    document.getElementById("buttonReadFromFile").innerText = document.webL10n.get('readFromFile');
                    document.getElementById("buttonReadFromMicro").innerText = document.webL10n.get('readFromMicro');
                }); 
                
            </script>
        </div>  
    </div>

    <div style="display: block;">
        <p id="partial" style="text-align: center; color: #4C6777;">
        </p>
    </div>
    
    <div id="textbox"  class="mousetrap" contenteditable="true">
        <p data-l10n-id="d-txt1">Enter your transcript here...</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <p data-l10n-id="d-txt2">Protips:</p>
        <p>&nbsp;</p>
        <p data-l10n-id="d-txt3">- <em>Ctrl+I</em> adds <em>italic</em> formatting and <b>Ctrl+B</b> adds <b>bold</b> formatting.</p>
        <p data-l10n-id="d-txt4">- Press ESC to play/pause, and Ctrl+J to insert the current timestamp.<p>
    </div>
    
    <div class="text-panel">
        <button class="sbutton bold" onclick="document.execCommand('bold',false,null);">
            <i class="fa fa-bold" id="icon-b"></i><span class="label" data-shortcut="bold">ctrl+b</span>
        </button>
        <button class="sbutton italic" onclick="document.execCommand('italic',false,null);">
            <i class="fa fa-italic" id="icon-i"></i><span class="label" data-shortcut="italic">ctrl+i</span>
        </button>
        <button class="sbutton time" onclick="window.insertTimestamp();">
            <i class="fa fa-clock-o"></i><span class="label" data-shortcut="addTimestamp">ctrl+j</span>
        </button>
        <div class="wordcount">
            <span class="wc-text">words</span>        
        </div>
        <button class="sbutton backup">
            <i class="fa fa-history"></i><span class="label" data-l10n-id="history-button">history</span>
        </button>
        <div class="import-file-wrapper">
            <button class="sbutton import">
                <i class="fa fa-sign-in" id="icon-imp"></i><span class="label" data-l10n-id="import-button">Import</span>
            </button>
            <input id="local-file-import" type="file" name="file" accept=".otr"  />
        </div>
        <button class="sbutton export">
            <i class="fa fa-share-square-o" id="icon-exp"></i><span class="label" data-l10n-id="export">Export</span>
            
        </button>
                              
        
    </div>
    <div class="export-panel">
        <div class="export-title" data-l10n-id="export-download">Download transcript as...</div>
        <a class="export-block-md" id="x-md" target="_blank"  data-l10n-id="export-markdown">Markdown (.md)</a>
        <a class="export-block-txt" id="x-txt" target="_blank" data-l10n-id="export-text">Plain text (.txt)</a>
        <a class="export-block-txt" id="x-otr" target="_blank" data-l10n-id="export-otr">oTranscribe format (.otr)</a>
        <div class="export-title" data-l10n-id="export-send">Send transcript to...</div>
        <a class="export-block-gd unauth" id="x-gd" target="_blank" href="javascript:void(0);">
            Google Drive
            <div class="sign-in" data-l10n-id="sign-in" id="x-gd-sign">Sign in</div>
        </a>
    </div>
    
    <div class="backup-panel">
        <div class="backup-description">
            <div class="backup-close"><i class="fa fa-times"></i></div>
            <div class="backup-title" data-l10n-id="history-title">Transcript history</div>
            <div class="backup-instructions" data-l10n-id="history-instrux-v2">A copy of your work is saved every five minutes. Backups are not stored for very long. Press Ctrl+S to save at any time.</div>
        </div>
        <div class="backup-window"><!-- backup blocks go here --></div>
    </div>
</div>


    <div class="settings-panel"></div>

    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.css" rel="stylesheet">
    
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-28041817-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


</body>

</html>
